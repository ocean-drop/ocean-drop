('use strict');
import crypto from 'crypto';
import { RippleAPI } from 'ripple-lib';
import Earth from './Earth.js';
import Ocean from './Ocean.js';

const rippleAPI = new RippleAPI({
  server: 'wss://s1.ripple.com',
});

const tsunamiASCII = `
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â €â €â¢€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¡€â €â €â €â €â €â €â €â¢€â €â  â¢€â ¢â €â â  â£€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â  â €â €â €â €â €â €â €â €â¢€â €â¢ â¢©â¢Šâ ˆâ¢â£€â¢°â¡¨â „â €â ¢â¢€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â  â €â €â €â €â €â¡ â¢ â  â â €â¢¨â¢˜â£ˆâ ¢â£¶â¢ˆâ£â¡€â â ˆâ¢¤â ™â¢’â šâ €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â  â ‚â €â €â €â €â â €â  â¢‰â¢â£ â¢›â£¿â£¶â¢€â¡™â£·â£¿â£¿â£­â£‚â ”â ¤â£„â¢±â¢â¢¢â¢°â  â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â °â â €â €â €â €â €â €â €â£¶â£¸â¢¨â¡·â£¹â£¾â£¾â£»â£¿â£·â¢Ÿâ£¿â£¿â£¾â£¶â °â¡¤â ˜â¢€â¢„â ”â ”â£€â¢ˆâ¢ˆâ €â¢ â¡ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â¢€â â â €â €â €â €â €â €â €â €â €â »â£¿â£â£·â£â£¿â£Ÿâ¢¾â¡¿â¢¿â£½â£¿â£¿â ¿â¡¿â ¾â¢€â¢°â ¢â¢ â ¨â ˆâ¡€â¢„â¢â¡¨â šâ¢€â¢ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â£¤â¢¤â£°â ’â ˆâ €â €â €â €â  â¢€â¢â â  â €â €â €â¡€â €â ˆâ ‰â¢€â¢°â£¿â£Ÿâ£¯â£¿â ¿â£¿â£Ÿâ¢¼â£¼â ™â ˆâ ¹â  â¢ˆâ ¤â¢â  â €â¢ˆâ °â¢¸â ‚â €â â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â šâ €â €â¢€â¢€â¢€â¢ â¢€â €â¢â¢€â â¢â €â â¢€â£€â¢ â â¢¨â¡€â£ˆâ ‰â  â ˜â£Œâ ¿â »â£¿â£Ÿâ£¯â €â €â €â €â €â ˜â¢‰â €â ˆâ €â¡…â ˆâ °â ˜â ‚â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â¢â¢ â¢€â¢ â¡Œâ¢°â£¶â£žâ¡˜â €â¡ â¢â¢€â ˜â£¼â£¨â¡Œâ£´â  â£¼â¢ â¡†â¢°â£¸â£¸â£¼â£¿â¢¸â €â €â €â €â €â €â €â €â €â ˆâ ¸â ˆâ ˜â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â  â ˆ
â €â €â â¡ˆâ£¡â£¼â¡¨â ‰â ¹â£¾â£¿â¢¿â¢€â ¸â ˜â €â €â ›â ­â ›â ›â£â£Ÿâ¢½â£»â£¶â£®â¢¿â£½â£¿â£¿â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â â €â €â €
â °â €â£°â£½â¢¿â£¿â£‡â£¤â â£´â£¶â£¿â£›â£€â ¸â¡€â â ªâ¢ â ¦â£˜â¢ºâ£»â£¿â£¿â£½â ¿â¡·â¢¿â£¶â£¾â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â â €â €â â  â €
â â ’â €â €â °â£¦â¡¿â¢¿â£·â£¿â£—â¢¾â¢â£¶â£¶â£½â£»â£®â â ¸â£†â£¯â£·â£¿â Ÿâ ‰â ‹â¢¾â£¾â£Ÿâ£›â¢†â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â  â €â €â¢â¢’â €â ³â£¾
â¢°â¢¨â¢â¢°â£€â  â¢Œâ£šâ£¾â¢¾â£¶â£Ÿâ£¼â£¾â£¿â£½â£¿â£¿â£®â££â£¿â£Ÿâ Ÿâ â €â €â €â €â €â €â ™â£³â£¦â¢°â¢¸â¢€â €â €â €â¢€â €â €â¢€â¢€â €â €â¢ â €â €â €â €â €â €â €â €â¢€â €â €â¢ â¢€â£€â €â €â¢€â €â¢€â¢â¢€â €â €â ¤â ‰â¡€â €â €â£€â£€â ªâ£¿â£¼
â €â â¢šâ£¾â¡¾â ¹â£¿â£»â£¿â£·â£½â£¾â£»â£¿â£¿â£¿â£•â£Ÿâ£¿â ­â Šâ €â €â €â¢€â ‚â¢„â €â €â €â €â â ›â£¿â£¼â¢€â €â šâ¢€â  â €â¢â €â¢€â¢ â¢ â¢´â¢¸â¢ â ¸â¢¼â¢â¢ â¢€â¢â â €â¢€â¢€â €â¢¸â£€â €â¢€â£€â¢ â¢€â â¡°â ‰â €â €â €â£¤â£¾â£¶â£­â£¿â¡¾â¢›
â¢˜â €â €â ¹â£¿â£—â¢½â£¶â¡¿â£¿â£¿â£¿â£¿â£¿â ¿â ›â¢‰â¢€â €â €â €â €â¡ â£¸â¡€â¢¼â €â €â €â €â €â €â â¢â €â ¨â ™â¢€â ¿â €â¢¾â ›â¢ â¢¿â¢°â£µâ£¼â¢¿â¢‰â£°â €â¡ˆâ »â¢¼â¢´â¡â ‰â¢›â¢¸â£€â£¸â¢¸â¢¸â Šâ €â£©â ¾â¢‰â €â â â¢€â â£¶â¡”â â¢ˆâ „â ˆâ¢€
â €â €â €â €â ˆâ ™â ›â ‰â ‰â €â €â¢€â¢€â €â €â €â €â¡”â €â €â ˆâ¢¨â¢€â €â ‚â¢â¢’â¢°â ˆâ¢€â¢°â €â¡¢â €â â¡ â¢€â €â ˆâ â ˆâ£“â£¾â¢¸â ¬â ‰â¡Ÿâ£¿â ‰â¢¹â¢¿â£¿â£¶â£´â£¬â¡—â €â °â â¢ â£€â£â¢¹â  â Šâ¡ â£°â£ˆâ£´â ¶â ™â ‰â ˆâ €â  â ‚â €â €â €â €
â €â €â €â €â¢ â¢â¢ â¢â €â â €â¢ˆâ¢€â °â£ â¡â¢˜â¢â €â¢°â €â¢€â ˆâ ‚â €â â ˆâ €â €â¡¦â¢®â£¿â¡¸â¢˜â €â£ˆâ ¢â£œâ£¦â ™â ¶â£€â €â â ºâ¢€â €â  â¢¸â¢¸â¢ºâ£¿â£¿â£¹â¡‡â£°â£„â  â  â£â ‚â ©â €â ’â Šâ ‰â ˆâ €â¢€â£¤â£¤â¡¶â ‹â €â €â €â €â£€â£¤â£¶
â €â €â €â €â ˜â â ¸â  â¢’â €â¢€â£€â£¤â£¿â£¿â£¤â¡ˆâ¢‚â €â â €â ¨â €â ‚â ¸â ˆâ €â ¨â €â¢¿â£ºâ£¾â£¿â¡ˆâ¡³â¡ˆâ£—â£¤â ›â£¿â£¿â£¾â£²â¡ˆâ£¤â£€â¢€â €â¢€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â â €â ¤â£¬â£­â¡½â ™â €â €â €â¢€â¢€â â ¶â£¬â£Ÿâ£»
â €â €â €â¢ â£”â£¬â¢°â¢”â¢®â£¿â¢¼â£·â¢¿â£¹â ¿â£›â €â¡€â¢€â¢â¢ªâ¢â¢°â£´â£ â£¿â Ÿâ¢ â£²â ˆâ¢¿â¢¿â£¿â£â£¾â£®â£¤â ™â¢¿â£¦â£ˆâ ›â¢¿â£¿â£¦â£›â¢¿â£¶â£¤â  â¢€â  â¢Œâ ‘â ²â¢¶â£¤â£’â£°â ¤â¢¬â£­â£¸â£’â£²â£¶â ’â â €â €â¢€â €â¢€â£€â£‰â£‰â£›â£›â£‹â£‰
â €â €â €â£¿â¢½â£½â »â£¿â¢·â£¿â£¾â£“â£ƒâ¢ â£„â €â¢€â ¼â ®â¢â ˆâ €â¢ˆâ£›â¢¿â£¿â¢°â¢¿â €â¢€â¢€â “â£¿â£¿â£Ÿâ¢¿â£¿â£¿â£¤â¢ˆâ »â£·â£¤â£€â ‰â ›â¢¿â£®â£â »â£·â£¶â£„â£€â â ˆâ¢‰â¢€â¢’â ˜â ¸â ¨â¢¬â ˜â ‰â €â €â¢ â£€â£â ²â ¼â ­â ¹â¢›â£›â£«â£©â£»â£›
â €â €â €â ¹â£¾â£©â£¶â£½â¡¿â£¿â£½â£½â£¿â£ºâ£»â¡¿â£—â €â¢€â£¼â£šâ¢€â£¶â¡‰â£Šâ£ â¢»â£Œâ£¤â£¸â£Œâ£ â €â ˆâ ›â »â£¿â£½â£¿â¢¾â£·â£¶â£Œâ¢™â »â£¿â£¶â£¤â£â£›â »â¢¿â£¿â£¿â£¿â£¿â£¿â ¿â »â ’â¢‰â¢€â£€â£€â£€â£€â£˜â¡»â¢¦â£¿â£¼â£¿â£¿â ¿â »â »â ¿â£¿â¢’â¢¸
â €â €â €â €â ™â¢¿â¢»â£¿â£¯â£­â¢¿â£¿â¢¿â£¿â£¿â£¾â£–â£€â¢¸â£®â¢²â£¿â£›â£¼â£¤â¢€â ‰â ¨â ªâ£¿â¢¹â£½â£¤â¢¹â£Œâ¢°â  â  â  â „â¢ˆâ¢ˆâ¢ˆâ ˆâ¢‰â â €â ˆâ ˆâ ˆâ¢ˆâ ˆâ ˆâ €â €â¢€â  â €â €â €â €â €â €â ˆâ¢‰â ‰â ‰â¢‰â¢‰â ˆâ €â¢€â €â €â €â €â €â €â €â €
`;

const wavesASCII = `
,(   ,(   ,(   ,(   ,(   ,(   ,(   ,(
  '-'  '-'  '-'  '-'  '-'  '-'  '-'  '-'
`;

rippleAPI.connect().then(async () => {
  //Get drops
  const drops = await Earth.getOceanDrops(rippleAPI, Ocean);

  if (drops.length === Ocean.AVAILABLE_DROPS) {
    //Shake the drops
    const shakedDrops = Ocean.shake(drops);
    //Pick random drop
    const randomDrop = crypto.randomInt(0, shakedDrops.length - 1);
    const {
      id,
      specification: {
        source: { address, tag },
      },
    } = shakedDrops[randomDrop];
    const str = tag ? `${address}:${tag}` : address;
    const tsunamiHeight = (Ocean.AVAILABLE_DROPS * 2).toString();

    const unfurlingTsunami = await rippleAPI.preparePayment(
      Ocean.LOCATION,
      Earth.generateWave(
        {
          wave: address,
          waveHeight: tsunamiHeight,
          id,
          tag,
        },
        Ocean
      )
    );

    console.log(tsunamiASCII);
    console.log(`${str}::${id}`, unfurlingTsunami);

    //WAVES
    console.log(wavesASCII);
    const waves = [];
    const dropsWithwaves = drops.filter(
      ({
        specification: {
          destination: { tag },
        },
      }) => {
        return tag;
      }
    );
    //Get waves drops
    const purifiedWaves = Object.entries(
      Ocean.filterEmptyWaves(Ocean.dropsByWaves(drops))
    ).filter((wave) => wave[1] > 1);

    purifiedWaves.forEach((wave) => {
      const [firstWave] = dropsWithwaves
        .filter(
          ({
            specification: {
              destination: { tag },
            },
          }) => {
            return tag === parseInt(wave[0]);
          }
        )
        .sort(
          (
            { outcome: { timestamp: timestampA } },
            { outcome: { timestamp: timestampB } }
          ) => {
            return new Date(timestampA) - new Date(timestampB);
          }
        );

      firstWave.waveHeight = wave[1] - 1;
      waves.push(firstWave);
    });

    await Promise.all(
      waves.map(async (wave) => {
        const {
          id,
          specification: {
            source: { address, tag },
          },
          waveHeight,
        } = wave;

        const unfurlingWaves = await rippleAPI.preparePayment(
          Ocean.LOCATION,
          Earth.generateWave(
            {
              wave: address,
              waveHeight: waveHeight.toString(),
              id,
              tag,
            },
            Ocean
          )
        );

        console.log(unfurlingWaves, ',');
      })
    );

    process.exit(0);
  }

  console.log('The tsunami is comming ðŸŒŠ...');
  process.exit(1);
});
